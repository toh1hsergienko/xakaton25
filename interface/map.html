<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=52b1dace-d2d5-4f52-a969-b2623534206a&lang=ru_RU"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
        }
        
        #map {
            width: 100%;
            height: 100vh;
        }
        
        .control-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .search-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .route-button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .categories {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .category-btn {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .category-btn:hover {
            background: #e0e0e0;
        }
        
        .category-btn.active {
            background: #2196F3;
            color: white;
            border-color: #2196F3;
        }
        
        .user-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="control-panel">
        <div class="search-container">
            <input type="text" id="start-point" class="search-input" placeholder="–û—Ç–∫—É–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ú–æ—Å–∫–≤–∞, –ö—Ä–∞—Å–Ω–∞—è –ø–ª–æ—â–∞–¥—å)">
            <input type="text" id="end-point" class="search-input" placeholder="–ö—É–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ú–æ—Å–∫–≤–∞, –í–î–ù–•)">
            <button class="route-button" onclick="calculateRoute()">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
        </div>
        
        <div class="categories">
            <button class="category-btn" onclick="searchPlaces('—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è')">üé≠ –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</button>
            <button class="category-btn" onclick="searchPlaces('—Å–ø–æ—Ä—Ç')">‚öΩ –°–ø–æ—Ä—Ç</button>
            <button class="category-btn" onclick="searchPlaces('–¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏')">üèõÔ∏è –î–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</button>
            <button class="category-btn" onclick="searchPlaces('–∫–∞—Ñ–µ')">‚òï –ö–∞—Ñ–µ</button>
            <button class="category-btn" onclick="searchPlaces('—Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã')">üçΩÔ∏è –†–µ—Å—Ç–æ—Ä–∞–Ω—ã</button>
            <button class="category-btn" onclick="searchPlaces('–º–∞–≥–∞–∑–∏–Ω—ã')">üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω—ã</button>
        </div>
    </div>
    
    <div class="user-info" id="user-info">
        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <span id="username">–ì–æ—Å—Ç—å</span>
    </div>
    
    <div id="map"></div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let map, multiRoute, placemarks = [];
        let username = '–ì–æ—Å—Ç—å';
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        ymaps.ready(init);
        
        function init() {
            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É
            map = new ymaps.Map("map", {
                center: [55.7558, 37.6173], // –ú–æ—Å–∫–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                zoom: 12
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–∏—Å–∫
            const searchControl = new ymaps.control.SearchControl({
                options: {
                    provider: 'yandex#search',
                    noPlacemark: true
                }
            });
            map.controls.add(searchControl);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∏–∑ –ø–æ–∏—Å–∫–∞
            searchControl.events.add('resultselect', function (e) {
                const results = searchControl.getResultsArray();
                const selected = results[e.get('index')];
                addPlacemark(selected.geometry.getCoordinates(), selected.properties.get('name'));
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
            initSuggest();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage
            const savedUsername = localStorage.getItem('username');
            if (savedUsername) {
                username = savedUsername;
                document.getElementById('username').textContent = username;
            }
        }
        
        function initSuggest() {
            // –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            new ymaps.SuggestView('start-point');
            new ymaps.SuggestView('end-point');
        }
        
        function calculateRoute() {
            const start = document.getElementById('start-point').value;
            const end = document.getElementById('end-point').value;
            
            if (!start || !end) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é –∏ –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫–∏');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            showLoading(true);
            
            // –ì–µ–æ–∫–æ–¥–∏—Ä—É–µ–º —Ç–æ—á–∫–∏
            Promise.all([
                ymaps.geocode(start),
                ymaps.geocode(end)
            ]).then(function(results) {
                const startCoords = results[0].geoObjects.get(0).geometry.getCoordinates();
                const endCoords = results[1].geoObjects.get(0).geometry.getCoordinates();
                
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –º–∞—Ä—à—Ä—É—Ç
                if (multiRoute) {
                    map.geoObjects.remove(multiRoute);
                }
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç
                multiRoute = new ymaps.multiRouter.MultiRoute({
                    referencePoints: [startCoords, endCoords],
                    params: {
                        routingMode: 'pedestrian' // –ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ 'auto' –∏–ª–∏ 'masstransit'
                    }
                }, {
                    boundsAutoApply: true,
                    wayPointStartIconColor: '#00FF00',
                    wayPointFinishIconColor: '#FF0000'
                });
                
                map.geoObjects.add(multiRoute);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫–∏
                addPlacemark(startCoords, '–ù–∞—á–∞–ª–æ: ' + start);
                addPlacemark(endCoords, '–ö–æ–Ω–µ—Ü: ' + end);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Ä—à—Ä—É—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é
                saveToHistory(start, end);
                
            }).catch(function(error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–µ–¥–µ–Ω–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤.');
                console.error('Route error:', error);
            }).finally(function() {
                showLoading(false);
            });
        }
        
        function searchPlaces(category) {
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –º–µ—Ç–∫–∏
            clearPlacemarks();
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ü–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã
            const center = map.getCenter();
            
            // –ò—â–µ–º –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            ymaps.geocode(center, {
                kind: 'house',
                results: 1
            }).then(function (res) {
                const nearest = res.geoObjects.get(0);
                if (nearest) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–∏—Å–∫ –ø–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º
                    const searchControl = new ymaps.control.SearchControl({
                        options: {
                            provider: 'yandex#search',
                            kind: 'business'
                        }
                    });
                    
                    // –ò—â–µ–º –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –≤ —Ç–µ–∫—É—â–µ–π –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏
                    const bounds = map.getBounds();
                    searchControl.search(category, {
                        boundedBy: bounds,
                        strictBounds: true
                    }).then(function() {
                        const results = searchControl.getResultsArray();
                        results.forEach(function(result) {
                            addPlacemark(
                                result.geometry.getCoordinates(), 
                                result.properties.get('name') + '\n' + 
                                (result.properties.get('description') || '')
                            );
                        });
                    });
                }
            });
        }
        
        function addPlacemark(coords, title) {
            const placemark = new ymaps.Placemark(coords, {
                balloonContent: title
            }, {
                preset: 'islands#blueIcon'
            });
            
            map.geoObjects.add(placemark);
            placemarks.push(placemark);
        }
        
        function clearPlacemarks() {
            placemarks.forEach(pm => map.geoObjects.remove(pm));
            placemarks = [];
        }
        
        function showLoading(show) {
            // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
            const button = document.querySelector('.route-button');
            if (show) {
                button.textContent = '–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ...';
                button.disabled = true;
            } else {
                button.textContent = '–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç';
                button.disabled = false;
            }
        }
        
        function saveToHistory(start, end) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Ä—à—Ä—É—Ç –≤ localStorage
            const history = JSON.parse(localStorage.getItem('routeHistory') || '[]');
            history.unshift({
                start: start,
                end: end,
                timestamp: new Date().toISOString()
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –º–∞—Ä—à—Ä—É—Ç–æ–≤
            if (history.length > 10) {
                history.pop();
            }
            
            localStorage.setItem('routeHistory', JSON.stringify(history));
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Flet
        window.setUsername = function(name) {
            username = name;
            document.getElementById('username').textContent = username;
            localStorage.setItem('username', name);
        };
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞—á–∞–ª—å–Ω—ã—Ö —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞
        window.setRoutePoints = function(start, end) {
            document.getElementById('start-point').value = start;
            document.getElementById('end-point').value = end;
        };
    </script>
</body>
</html>